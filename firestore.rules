rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // analyticsコレクション（日次集計）
    match /analytics/{analyticsId} {
      // 読み取りは誰でも可能（管理画面で使用）
      allow read: if true;

      // datesサブコレクション
      match /dates/{dateId} {
        // 読み取りは誰でも可能
        allow read: if true;

        // 日次統計の作成・更新を許可（merge操作）
        allow create, update: if request.resource.data.date is string &&
                                request.resource.data.lastUpdated is string;

        // 削除は禁止（Cloud Functionsのみが削除可能）
        allow delete: if false;
      }

      // 古い形式のanalyticsドキュメントは読み取りのみ
      allow read: if true;
      allow write: if false;
    }

    // tracksコレクション
    match /tracks/{trackId} {
      // 読み取りは誰でも可能
      allow read: if true;

      // 作成・更新は制限付きで許可
      allow create: if request.resource.data.title is string &&
                      request.resource.data.artist is string &&
                      request.resource.data.status in ['pending', 'played'] &&
                      request.resource.data.totalRequests is number;

      // 更新は特定のフィールドのみ許可（論理削除用フィールドを追加）
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['totalRequests', 'status', 'playedAt', 'deletedAt', 'deletedBy']);

      // 物理削除は完全に禁止
      allow delete: if false;

      // requestsサブコレクション
      match /requests/{requestId} {
        // 読み取りは誰でも可能
        allow read: if true;

        // リクエストの作成は制限付きで許可
        allow create: if request.resource.data.nickname is string &&
                        request.resource.data.nickname.size() > 0 &&
                        request.resource.data.nickname.size() <= 50 &&
                        request.resource.data.keys().hasAll(['nickname', 'requestedAt']) &&
                        request.resource.data.keys().hasOnly(['nickname', 'message', 'requestedAt']);

        // 更新を許可（論理削除用）
        allow update: if request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['deletedAt', 'deletedBy']);

        // 物理削除は完全に禁止
        allow delete: if false;
      }
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // tracksコレクション
    match /tracks/{trackId} {
      // 読み取りは誰でも可能
      allow read: if true;

      // 作成・更新は制限付きで許可
      allow create: if request.resource.data.title is string &&
                      request.resource.data.artist is string &&
                      request.resource.data.status in ['pending', 'played'] &&
                      request.resource.data.totalRequests is number;

      // 更新は特定のフィールドのみ許可
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['totalRequests', 'status', 'playedAt']);

      // 削除は制限（管理者のみ）
      // 注意: 現状はクライアント側で削除を行っているため一時的に許可
      // 本番環境ではAPI Routeを使用すべき
      allow delete: if true; // TODO: 管理者認証を追加

      // requestsサブコレクション
      match /requests/{requestId} {
        // 読み取りは誰でも可能
        allow read: if true;

        // リクエストの作成は制限付きで許可
        allow create: if request.resource.data.nickname is string &&
                        request.resource.data.nickname.size() > 0 &&
                        request.resource.data.nickname.size() <= 50 &&
                        request.resource.data.keys().hasAll(['nickname', 'requestedAt']) &&
                        request.resource.data.keys().hasOnly(['nickname', 'message', 'requestedAt']);

        // 削除は制限（管理者のみ）
        // 注意: 現状はクライアント側で削除を行っているため一時的に許可
        allow delete: if true; // TODO: 管理者認証を追加

        // 更新は禁止
        allow update: if false;
      }
    }
  }
}
